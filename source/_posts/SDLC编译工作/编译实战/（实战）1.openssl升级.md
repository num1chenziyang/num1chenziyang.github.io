---
title: （实战）1.openssl升级
date: 2025-04-01 20:15:17
categories:
  - SDLC编译工作
  - 编译实战
tags:
  - openssl
  - 编译
password:
---

# （前言）机器详情

---

# （一）openssl介绍

总之，从 OpenSSL 1.0.1 升级到 OpenSSL 3.2.2 意味着获得显著的安全性提升、性能改善和更多先进的特性，但也可能需要对现有代码进行调整以适应新版 API 的变化。对于任何关心系统安全性的组织来说，升级到最新版本通常是推荐的做法。

- ==OpenSSL 1.0.1：提供的文档相对较少，社区和技术支持也集中在解决紧急问题上。==
- ==OpenSSL 3.2.2：拥有更加完善的官方文档，以及活跃的开发者社区和商业支持服务，帮助用户更好地理解和使用该库。==

==8. 文档和支持==

- ==OpenSSL 1.0.1：具有良好的向后兼容性，但是随着新版本的发展，这种兼容性逐渐减弱。==
- ==OpenSSL 3.2.2：强调向前兼容，同时也尽可能保持一定的向后兼容性，但在某些情况下为了提高安全性和效率，可能会打破旧版代码的兼容性。==

==7. 兼容性和移植性==

- ==OpenSSL 1.0.1：保留了一些老旧的功能，这些功能可能不再符合当前的安全要求。==
- ==OpenSSL 3.2.2：移除了许多被认为不安全或不必要的功能，确保用户只能选择安全的配置选项。==

==6. 弃用和移除的功能==

- ==OpenSSL 1.0.1：性能上虽然已经进行了很多优化，但相比最新版本还是有所不足。==
- ==OpenSSL 3.2.2：包含了大量的性能改进，特别是在处理大规模并发连接时表现更为出色。新版本还利用了现代 CPU 的特性，如 AVX 指令集，以加速加密运算。==

==5. 性能优化==

- ==OpenSSL 1.0.1：API 设计较为传统，但有些部分不够直观。==
- ==OpenSSL 3.2.2：API 经历了重构，更加现代化，提供了更好的抽象层次和易用性。某些低级别的 API 已经被废弃，鼓励使用更高层次的接口来简化应用开发。==

==4. API 变化==

- ==OpenSSL 1.0.1：支持当时的 SSL/TLS 协议版本，包括 TLS 1.0, 1.1 和 1.2。==
- ==OpenSSL 3.2.2：增加了对 TLS 1.3 的支持，这是目前最安全且高效的 TLS 版本。同时，移除了对不安全或过时协议的支持（如 SSLv2/v3 和 TLS 1.0/1.1）。==

==3. 特性增加==

- ==OpenSSL 1.0.1：存在一些已知的安全漏洞，例如臭名昭著的心脏出血漏洞（Heartbleed Bug），这使得服务器内存中的敏感数据可能被泄露。==
- ==OpenSSL 3.2.2：引入了许多安全补丁，修复了多个以前版本中存在的漏洞，并增强了整体的安全性。新的版本也遵循更严格的安全编码标准。==

==2. 安全性增强==

- ==OpenSSL 1.0.1：发布于2012年，是较旧的一个版本。==
- ==OpenSSL 3.2.2：属于最新的稳定分支之一，代表了更现代的技术水平。==

**OpenSSL 简介**  
==OpenSSL 是一个强大的、通用的密码库，实现了广泛的加密算法。它不仅提供了安全套接层（SSL）和传输层安全（TLS）协议的全面实现，还提供了一个功能丰富的应用程序编程接口（API），用于开发人员在他们的应用程序中集成安全通信功能。此外，OpenSSL 包含了一系列命令行工具，可以用来执行与加密相关的操作，如生成密钥对、创建证书请求、签署证书等。==  
==OpenSSL 1.0.1 和 OpenSSL 3.2.2 的区别==  
==从 OpenSSL 1.0.1 到 OpenSSL 3.2.2，这个开源项目经历了重大的发展和改进。以下是一些主要的区别点：==  
==1. 版本发布周期==

---

# （二）openssl3.2.2源码编译安装
## 一.修改编译配置（ids/vobs/3rd_party/openssl）
### 1.call_makefile.sh
make all OPENSSL_NVR=openssl-3.3.2 BITS_32_OR_64=64 PLATFORM=x84_64


### 2.makefile
（1）SOURCE_DIR：给出绝对路径  
（2）OPENSSL_SRC：确保路径能指到openssl-3.3.2.tar.gz  
（3）./config 处添加no-threads（禁用线程支持）  
<1>解决 pthread_mutex_trylock 编译报错问题。  
<2>如果无no-threads，则代码编译报错处加-lpthread（目前看来也没问题）  
（4）想要 gdb 调试 openssl，需要在./config 处添加-d --debug
 
### note：
1.gdb 调试 openssl 找不到 ssl 的文件  
解压 openssl 的源码包，通过 dir 设置源文件路径：(gdb) dir /home/czy/openssl-3.2.2


### 3.sh call_makefile.sh
执行此脚本，将 openssl3.2.2 安装到了/usr/cm/nightly_build/builds/openssl  
（需要修改一下安装好后的 openssl-3.2.2 目录结构，因为调用到 openssl 的配置都是用的修改后的路径）
 
openssl-3.2.2_x86_64_phno  
|----64  
----|----86_64 --------> linux86_64(linuxaarch64)  
--------|----bin  
--------|----include  
--------|----lib64 --------> lib  
--------|----share  
--------|----ssl

在 **龙芯架构（LoongArch）** 上编译 OpenSSL 3.2.2 时出现 bn_div_fixed_top: impossible constraint in 'asm' 错误，通常是由于 **汇编代码与龙芯指令集或编译器约束不兼容** 导致。以下是具体解决方案：

**一、问题原因**

- **汇编优化冲突**：OpenSSL 的 bn_div_fixed_top 函数在龙芯架构的汇编代码中使用了不支持的约束条件（如寄存器分配或指令格式）。
- **编译器兼容性**：龙芯平台的编译器（如 loongarch64-linux-gnu-gcc）可能对某些内联汇编语法支持不足。
 
**二、解决方案**  
**1. 禁用汇编优化**  
通过 no-asm 配置选项跳过汇编代码，强制使用 C 语言实现（牺牲部分性能，但确保编译通过）：  
./Configure linux-loongarch64 --prefix=/opt/openssl no-asmmake cleanmakesudo make install  
**2. 指定正确的目标架构**  
确保 Configure 命令中目标架构与龙芯型号匹配：

- **龙芯 3A5000/3C5000（LoongArch64）**：./Configure linux-loongarch64 --prefix=/opt/openssl
- 若 OpenSSL 旧版本未支持 linux-loongarch64，尝试使用通用 MIPS64 配置：./Configure linux64-mips64 --prefix=/opt/openssl

**3. 更新 OpenSSL 源码**  
OpenSSL 官方可能已修复此问题，建议从 Git 仓库拉取最新代码：  
git clone [https://github.com/openssl/openssl.git](https://github.com/openssl/openssl.git)cd opensslgit checkout openssl-3.2.2./Configure linux-loongarch64 --prefix=/opt/openssl  
**4. 调整编译器选项**  
在配置时添加 -O1 或禁用某些优化：  
CFLAGS="-O1 -Wno-error=implicit-function-declaration" \./Configure linux-loongarch64 --prefix=/opt/openssl  
**5. 手动修复汇编代码（高级）**  
定位到报错文件（如 crypto/bn/asm/loongarch64-gcc.c），修改内联汇编约束：  
// 原始代码可能包含不支持的约束（如 "r" 或 "f"）asm volatile ("add.d %0, %1, %2" : "=r"(out) : "r"(a), "r"(b));  
// 修改为龙芯支持的寄存器约束（参考龙芯编译器手册）asm volatile ("add.d %0, %1, %2" : "=vr"(out) : "vr"(a), "vr"(b));
 
**三、验证安装**  
检查二进制架构file /opt/openssl/bin/openssl，预期输出应包含 "LoongArch" 或 "MIPS64"
查看 OpenSSL 信息/opt/openssl/bin/openssl version -a
 
**四、附录：龙芯环境配置建议**

1. **更新编译器**：确保使用龙芯官方提供的 gcc（如 loongarch64-linux-gnu-gcc）。
2. **依赖库**：安装龙芯架构的基础开发库：sudo apt-get install libc6-dev-loongarch64
3. **社区支持**：若问题仍存，参考龙芯开源社区或提交 Issue：
    
    - [龙芯开源社区](https://forum.loongnix.cn/)
    - [OpenSSL GitHub Issues](https://github.com/openssl/openssl/issues)

---

# （三）openssl3.2.2代码适配
## 一.ids

## 二.csdk

## 三.share

---

# （四）通讯加密
## 一.通讯加密模块调试
### 1.配置好通讯加密


### 2.gdb调试加密 VP
（1）onstat -g glo  
（2）找到 encrypt 的 vp 的 pid，如 3459  
（3）gdb attach 3459  
（4）b openssl_init_ctx（此接口是 openssl 模块的主接口，直接断在此即可）

### note：
1.证书密码问题
（1）生成加密的证书
当 openssl 工具加入参数如：-passin pass:11111111 时，证书并未加密，此为 openssl3.2.2 的问题。未加密的证书导致 .ext 文件无论配置密码与否 dbaccess 都能连上数据库。应该使用手动输入密码方式对证书进行加密，即加入参数：-aes256，然后回车之后直接输入密码即可。
 
（2）ext 下密文密码的使用
注意，ext 文件下的密码，应该是密文，进入openssl_init_ctx 接口后，会对写在 ext 文件的密码进行解密。所以，如果证书的密码是 11111111，我们需要使用 ids/bin 下的工具进行加密，再将密文密码写到 ext 文件中。  
**./gbspwdenc 11111111**，得到结果：DqOULNa1c2OMcEEbvTG30w==