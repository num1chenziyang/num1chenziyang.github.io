---
title: （实战）7.New_Start_V6-aarch64
date: 2025-04-03 00:27:21
categories:
  - SDLC编译工作
  - 编译实战
tags:
  - 编译
password: 9761565829chen
---
# （前言）机器详情

| 2025-03-28 |                |                     |
| ---------- | -------------- | ------------------- |
| ipv4       | 172.16.3.40    | ifconfig            |
| 架构         | zncgsl6        | uname -a            |
| 处理器        | 虚拟机            | 虚拟机                 |
| 系统         | NeoKylin（中标麒麟） | cat /etc/os-release |
| 机房位置       | 实体机位置          | 172.16.3.20华为机      |
| 密码         | root           | Big4ifmx            |

---

# （一）机器搭建
## 一.镜像下载
产品没有提供相应的镜像文件，需要自己找
https://www.gd-linux.com/


## 二.虚拟机搭建
### 一.虚拟机工具
对于 aarch64 来说，vmware 无法使用，所以使用 qemu+kvm 虚拟机
#### 1. 安装 QEMU/KVM 和依赖
##### 1. **QEMU/KVM**  
   - 虚拟化引擎，提供硬件模拟和 KVM 加速。
   - 依赖项：  
     - `qemu-kvm`（KVM 加速支持）
     - `qemu-system`（多架构模拟）
     - `qemu-utils`（磁盘管理工具，如 `qemu-img`）
##### 2. **virt-manager**  
   - 图形化虚拟机管理工具。
   - 依赖项：  
     - `libvirt`（虚拟化 API 和工具集）
     - `virt-viewer`（虚拟机控制台连接工具）
     - `dnsmasq`（轻量级 DHCP/DNS 服务）
     - `bridge-utils`（网络桥接工具）
##### 3. **Libvirt**  
   - 虚拟化管理后端，支持多种虚拟化技术（QEMU/KVM、LXC 等）。
   - 依赖项：  
     - `libvirt-daemon`（守护进程）
     - `libvirt-clients`（客户端工具如 `virsh`）
##### 4. **Gtk**
   - 图形化组件

总的来说就是配置好 yum 源后，将 \*qemu\*、\*virt\*、\*Gtk\*相关的资源都装好


### 二. 启动 virt-manager 工具进行安装
安装过程不难，对出现的问题进行记录：
#### 1. 安装时机器类型选择
对于 New_Start_V6来说，机器类型选择 redhat7即可

#### 2.Gtk 问题
“Gtk-WARNING : cannot open display;”或“Cannot connect to display;“
此问题的原因是没有设置环境变量 DISPLAY，设置这个环境变量后，virt-manager 会把图形操作界面输出到指定 IP 的桌面上。
```shell
##我的远程桌面IP为172.16.3.86，我通过 windterm 连接服务器
export DISPLAY="172.16.3.86:0.0"
```
这样运行 virt-manager 即可输出到我的远程桌面上

#### 3.网络配置问题
1.虚拟机的网卡直接设置桥接模式即可，选择宿主机正在启用的网卡，需要在同一网段。在没有新建单独的网桥的情况下，宿主机无法连通虚拟机。
2.一般来说配置完桥接之后，网络是没问题的。如果此时虚拟机还是连不上网或者 ssh 有问题，那么大都是因为虚拟机自身的网络配置原因。 


### 三.虚拟机网络配置
对于新支点操作系统来说，虚拟机的安装过程是容易的。但是网络配置着实让人十分难受 QAQ..，主要出现以下问题： 1.虚拟机能 ping 通其他机器但是其他机器无法 ping 通虚拟机。2.能互ping 后其他机器无法 ssh 虚拟机，虚拟机本身也无法 ssh 到 127.0.0.1（主机环回）。下面介绍两个问题的解决方法：
#### 1.ping
1.彻底关闭防火墙
对于一般系统而言，使用如下命令即可彻底关闭防火墙：
```bash
systemctl stop firewalld
systemctl disable firewalld

service iptables stop
systemctl stop iptables

iptables -L           ##查看状态
firewall-cmd --state  ##查看状态
```
但是显然这个系统不一般，这样操作后，看防火墙没打开也没加载，但是就是ping 不通。通过调查，得知需要做如下操作：
```bash
iptables -P INPUT ACCEPT    ##允许所有为匹配到规则的数据包都通过
iptables -P OUTPUT ACCEPT   ##......
iptables -P FORWARD ACCEPT  ##......
iptables -F                 ##清空默认表（filter）的所有规则
```
做完这些操作，其他机器即可 ping 通此虚拟机，但是 ssh 仍然不行。

#### 2.ssh
对于一般系统而言，使用如下方法即可让 ssh 通：
```bash
vim /etc/ssh/sshd_config

##配置PermitRootLogin yes
PermitRootLogin yes
```
但是显然这个系统不一般，这样操作后，ssh 仍然不可。这时候发现 ssh 127.0.0.1（主机环回）也不行。查看了一下网络的日志信息：tail -f /var/log/messages，看到报错信息：# "not allowed because listed in DenyUsers"。确定了是 root 用户没有 ssh 的权限导致，最终在 sshd_config 找到罪魁祸首。
```bash
vim /etc/ssh/sshd_config

##删除“AllowUsers”、“DenyUsers”、“DenyGroups”、“AllowGroups”，字段或者在配置项前添加“#”：

#AllowUsers root
#DenyUsers gbasedbt
#AllowGroups root
#DenyGroups gbasedbt
```

#### 3.ssh 连接自动断开
```bash
##将TMOUT的值设置为 0，然后重启
vim /etc/profile

export TMOUT=0
```

---

# （二）编译环境搭建
见内部文章：[[1.项目编译环境搭建]]

---

# （三）代码适配
## 一.csdk
### 1.XSLT Error
发现是/opt/InstallAnywhere有误，替换了 168 的 docker 下的 /opt/InstallAnywhere至此，编译通过（xml.jar做对了）。


## 二.ids
### 1.usr/bin/ld：cannot find lelf-0.160
原因是系统的库是/usr/lib64/libelf-0.186.so，直接做软链接编译通过：
```shell
ln -s /usr/lib64/libelf-0.186.so /usr/lib64/libelf-0.160.so
```

---

# （四）特殊问题记录
## 1.缺少四个its_文件

| 报错位置                         | 报错内容                                                                                                                                                                                                 |
| ---------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| csdk/vobs/tristarm/media.out | Could not locate file: /home/...../its_ecleants<br>Could not locate file: /home/...../its_ecreatets<br>Could not locate file: /home/...../its_eload<br>Could not locate file: /home/...../its_stager |
有一处编译开关会决定是否把这四个文件编译进去，aarch64 中不编这四个，此报错正常。
