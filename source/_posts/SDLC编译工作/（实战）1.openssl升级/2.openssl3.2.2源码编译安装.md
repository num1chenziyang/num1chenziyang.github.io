# 一.修改编译配置（ids/vobs/3rd_party/openssl）

## 1.call_makefile.sh

make all OPENSSL_NVR=openssl-3.3.2 BITS_32_OR_64=64 PLATFORM=x84_64
   

## 2.makefile

（1）SOURCE_DIR：给出绝对路径  
（2）OPENSSL_SRC：确保路径能指到openssl-3.3.2.tar.gz  
（3）./config 处添加no-threads（禁用线程支持）  
<1>解决 pthread_mutex_trylock 编译报错问题。  
<2>如果无no-threads，则代码编译报错处加-lpthread（目前看来也没问题）  
（4）想要 gdb 调试 openssl，需要在./config 处添加-d --debug
 
## note：

1.gdb 调试 openssl 找不到 ssl 的文件  
解压 openssl 的源码包，通过 dir 设置源文件路径：(gdb) dir /home/czy/openssl-3.2.2
   

## 3.sh call_makefile.sh

执行此脚本，将 openssl3.2.2 安装到了/usr/cm/nightly_build/builds/openssl  
（需要修改一下安装好后的 openssl-3.2.2 目录结构，因为调用到 openssl 的配置都是用的修改后的路径）
 
openssl-3.2.2_x86_64_phno  
|----64  
----|----86_64 --------> linux86_64(linuxaarch64)  
--------|----bin  
--------|----include  
--------|----lib64 --------> lib  
--------|----share  
--------|----ssl
                  

在 **龙芯架构（LoongArch）** 上编译 OpenSSL 3.2.2 时出现 bn_div_fixed_top: impossible constraint in 'asm' 错误，通常是由于 **汇编代码与龙芯指令集或编译器约束不兼容** 导致。以下是具体解决方案：
 
**一、问题原因**

- **汇编优化冲突**：OpenSSL 的 bn_div_fixed_top 函数在龙芯架构的汇编代码中使用了不支持的约束条件（如寄存器分配或指令格式）。
- **编译器兼容性**：龙芯平台的编译器（如 loongarch64-linux-gnu-gcc）可能对某些内联汇编语法支持不足。
 
**二、解决方案**  
**1. 禁用汇编优化**  
通过 no-asm 配置选项跳过汇编代码，强制使用 C 语言实现（牺牲部分性能，但确保编译通过）：  
./Configure linux-loongarch64 --prefix=/opt/openssl no-asm￼make clean￼make￼sudo make install￼  
**2. 指定正确的目标架构**  
确保 Configure 命令中目标架构与龙芯型号匹配：

- **龙芯 3A5000/3C5000（LoongArch64）**：￼./Configure linux-loongarch64 --prefix=/opt/openssl￼
- 若 OpenSSL 旧版本未支持 linux-loongarch64，尝试使用通用 MIPS64 配置：￼./Configure linux64-mips64 --prefix=/opt/openssl￼

**3. 更新 OpenSSL 源码**  
OpenSSL 官方可能已修复此问题，建议从 Git 仓库拉取最新代码：  
git clone [https://github.com/openssl/openssl.git](https://github.com/openssl/openssl.git)￼cd openssl￼git checkout openssl-3.2.2￼./Configure linux-loongarch64 --prefix=/opt/openssl￼  
**4. 调整编译器选项**  
在配置时添加 -O1 或禁用某些优化：  
CFLAGS="-O1 -Wno-error=implicit-function-declaration" \￼./Configure linux-loongarch64 --prefix=/opt/openssl￼  
**5. 手动修复汇编代码（高级）**  
定位到报错文件（如 crypto/bn/asm/loongarch64-gcc.c），修改内联汇编约束：  
// 原始代码可能包含不支持的约束（如 "r" 或 "f"）￼asm volatile ("add.d %0, %1, %2" : "=r"(out) : "r"(a), "r"(b));￼  
// 修改为龙芯支持的寄存器约束（参考龙芯编译器手册）￼asm volatile ("add.d %0, %1, %2" : "=vr"(out) : "vr"(a), "vr"(b));￼
 
**三、验证安装**  
# 检查二进制架构￼file /opt/openssl/bin/openssl￼# 预期输出应包含 "LoongArch" 或 "MIPS64"￼  
# 查看 OpenSSL 信息￼/opt/openssl/bin/openssl version -a￼
 
**四、附录：龙芯环境配置建议**

1. **更新编译器**：确保使用龙芯官方提供的 gcc（如 loongarch64-linux-gnu-gcc）。
2. **依赖库**：安装龙芯架构的基础开发库：￼sudo apt-get install libc6-dev-loongarch64￼
3. **社区支持**：若问题仍存，参考龙芯开源社区或提交 Issue：
    
    - [龙芯开源社区](https://forum.loongnix.cn/)
    - [OpenSSL GitHub Issues](https://github.com/openssl/openssl/issues)