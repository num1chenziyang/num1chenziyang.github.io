# 一.-fcommon

GCC 的 -fcommon 选项与处理全局变量的存储方式有关，特别是当同一个全局变量在多个文件中重复声明时。
 
## 1.背景：

在 C 语言中，如果在多个文件中使用了相同的全局变量名而没有使用 extern 关键字声明，这会导致“多重定义”问题。C 标准规定这样的变量要么应该有一个定义并使用 extern 来引用它，要么应该只定义一次。  
在老版本的 GCC 中，-fcommon 是默认启用的，这允许全局变量在多个源文件中重复声明，而不会引发链接错误。使用 -fcommon 时，这些变量会被放置在一个“公共”块中，在链接阶段将这些变量合并为一个实例。
 
## 2.示例：

假设有两个文件都定义了同样的全局变量：  
**a.c:**  
int global_var;  
**b.c:**  
int global_var;
 
如果使用 -fcommon 编译这两个文件，链接器会将这两个定义合并，不会报错：

## gcc -fcommon a.c b.c -o program

程序会成功编译并链接，因为 -fcommon 命令允许多个定义。
    
# 二.-fno-common：

从 **GCC 10** 开始，-fno-common 成为默认选项。这意味着 GCC 不再允许多个文件中出现相同的全局变量定义。改用 -fno-common 时，编译器会在链接时报告“多重定义”错误。
 
## 1.示例：

gcc a.c b.c -o program  
在 GCC 10 或更高版本中，链接阶段会报错：  
/usr/bin/ld: b.o:(.bss+0x0): multiple definition of `global_var'; a.o:(.bss+0x0): first defined here
 
此时解决办法可以是：  
将其中一个文件的全局变量声明为 extern，如在 b.c 中：  
**b.c:**  
extern int global_var;
    
# 三.总结：

- **-fcommon**：允许多个文件中重复定义全局变量（适用于老版本 GCC）。
- **-fno-common**（默认行为在 GCC 10 及以上）：强制全局变量只允许有一个定义，否则会在链接时报错。

如果你在迁移到新版本的 GCC 时遇到“多重定义”错误，可以暂时使用 -fcommon 选项作为兼容解决方案，但最好通过正确的 extern 声明来修复代码。
 
# -----------------------------------------------------------------------------------------------
 
# 一.-fcommon 和 -Wl,-allow-multiple-definition

在 GCC 10 中，-fcommon 和 -Wl,-allow-multiple-definition 都与处理全局变量的重复定义问题有关，但它们的作用范围和影响有所不同。  
**-fcommon**

- **作用**: 控制全局变量的存储方式。
- **默认行为**: 在 GCC 10 之前，默认是 -fcommon，这意味着全局变量可以在多个文件中重复定义，链接器会将它们合并为一个“common”符号。这种行为可以避免重复定义导致的链接错误。
- **在** **GCC 10** **中的变化**: 从 GCC 10 开始，默认行为变为 -fno-common。即，重复定义的全局变量不再被视为“common”符号，而是普通的定义符号。这意味着，如果在多个文件中定义了同名全局变量，链接器会报“multiple definition”错误。

**-Wl,-allow-multiple-definition**

- **作用**: 直接影响链接器（ld）的行为，允许重复定义符号。
- **使用场景**: 当你在多个目标文件（.o 文件）中定义了相同的全局变量或函数，并希望链接器忽略这些重复定义并继续生成可执行文件时，可以使用这个选项。
- **效果**: 这个选项通过 -Wl, 传递给链接器，并告诉它允许多个目标文件中存在相同符号的定义，而不会产生链接错误。它对所有符号都有效，包括全局变量、函数等。

**区别**

1. **处理范围**:
    
    - -fcommon 仅影响全局变量的处理方式，决定这些变量在编译时是被视为“common”符号还是普通的定义符号。
    - -Wl,-allow-multiple-definition 影响链接器的行为，对所有符号（不仅仅是全局变量）生效，允许重复定义。
2. **默认行为**:
    
    - 在 GCC 10 中，默认是 -fno-common，即不允许重复定义全局变量。
    - -Wl,-allow-multiple-definition 并不是默认行为，必须显式使用该选项。
3. **使用效果**:
    
    - -fcommon 是编译时的选项，影响代码的编译过程。如果使用 -fcommon，即便重复定义全局变量，链接时也不会出错。
    - -Wl,-allow-multiple-definition 是链接时的选项，可以在编译后通过该选项强制链接器忽略重复定义的错误。

**总结**

- **-fcommon** 影响的是全局变量的编译和链接方式，主要针对重复定义的全局变量。
- **-Wl,-allow-multiple-definition** 是一个更广泛的选项，影响链接器的行为，允许多个重复定义的符号（不仅限于全局变量）。