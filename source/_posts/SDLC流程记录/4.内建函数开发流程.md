---
title: 4.内建函数开发流程
date: 2025-04-23 15:25:56 
categories: 
- SDLC流程记录
- 
tags: 
password: 9761565829chen
---
![](../../attachments/SDLC流程记录/to_date%20结构图.png)
# 一.添加 OP 、PS与内建函数注册

语法解析遇到函数时，会首先尝试用内建函数数组 builtin_udrs[]去匹配 bltfprcc.c，成功了则转化为语法树上的一个操作符（OP），不成功则去 UDR 匹配。

## 1.添加 PS

p_type_t.h

内建函数的编号定义在 p_type_t.h，此文件添加新的编号，并且修改最大编号的值

#define PS_ORA_TO_DATE 290

#define PS_OPMAX PS_ORA_TO_DATE

## 2.添加 OP

sp2expr.c

if (PS_OPMAX != 290)

......

OP_ORA_TO_DATE,-1,-1,-1,-1

expr.h

//expression operators 表达式操作符

typedef enum enum_xop_t

{

    ....,

    OP_ORA_TO_DATE,

    XOP_END,

}

## 3.生成 bltfprcc.c（[bltf 系列文件](onenote:https://d.docs.live.net/5C75E3F46AA7FCD5/OneNote/SDLC流程记录/流程类.one#2.重做%20bltfprcc.c%20流程&section-id={EE7A8511-426F-411F-AA49-25811C710B77}&page-id={C5281CE8-DB1D-C743-B21B-A9B9043F1435}&object-id={DAF02088-BFF7-4AF0-AE20-05FE1F761B47}&2E)）

bltfprcc.in

bltfprcc.c

# 二.内建函数具体实现

## 1.时间、文本等格式处理函数文件

fmtrans.c

fmtrans.h

trans_to_datetime

trans_convert_input

## 2.to_date 的外层函数

sqexprfn.c

sqexprfn.h

fnorcl_to_date

## 3.加入 geval

sqexpr.c

1.添加 case

2.加入到 geval 函数中

3.处理返回类型

## 4.添加错误码

en_us/0333/errmsgtxt

en_us/0333/sql.msg

zh_cn/e00d/errmsgtxtsrc

zh_cn/e00d/sql.msg

替换错误码文件，编到makelibdwa，替换msg下的sql.iem

# 三.其他改动

squdr.c

加入多个 case，包含对参数个数的判断

sqhex.c

{ "to_date" }加入到函数 is_new_builtin_func

sqoptr.c

case OP_ORA_TO_DATE: 加入到函数 trace_expr_pre

sqoputil.c

case OP_ORA_TO_DATE: 加入到函数 is_lbac_safe_pred

sqtext.c

case OP_ORA_TO_DATE: 加入到函数 wrtexpr

sqtrace.c

ECASE(PS_ORA_TO_DATE,"ora_to_date") 加入到函数 sqtrace.c

sqxop.c

SCXA(ORA_TO_DATE,"TO_DATE",0);

case OP_ORA_TO_DATE   : xopAttr[i] = &ORA_TO_DATE ; break;

总而言之：

全局搜索PS_xxx，OP_xxx，仿照格式加入各位置

最后在sqxop.c的开头处添加SCXA的宏